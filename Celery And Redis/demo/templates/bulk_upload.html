<!DOCTYPE html>

{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bulk Upload Contacts</title>
</head>
<body>
    <h1>Bulk Upload Contacts</h1>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li style="color: {% if message.tags == 'error' %}red{% else %}green{% endif %};">
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <p>
            <label for="csv_file">Upload CSV file:</label>
            <input type="file" name="csv_file" required>
        </p>
        <button type="submit">Upload</button>
    </form>

    <p>Need a sample? 
        <a href="{% static 'sample_contacts.csv' %}" download>
            Download Sample CSV (100 contacts)
        </a>
    </p>



<h2>Status:</h2>
    <div id="status-box"></div>

    <script>
    console.log("Opening WebSocket…");  // debug
    const statusBox = document.getElementById("status-box");
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws_url = ws_scheme + "://" + window.location.host + "/ws/status/";
    console.log("Connecting to:", ws_url);

    const ws = new WebSocket(ws_url);

    ws.onopen = function() {
        console.log("✅ WebSocket connected!");
    };

    ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.message.startsWith("✅")) {
        // final result, append new line
        const p = document.createElement("p");
        p.textContent = data.message;
        statusBox.appendChild(p);
    } else {
        // live progress -> update single line
        statusBox.textContent = data.message;
    }
};


    ws.onerror = function(err) {
        console.error("WebSocket error:", err);
    };

    ws.onclose = function() {
        console.warn("WebSocket closed");
    };
</script>






</body>
</html>
